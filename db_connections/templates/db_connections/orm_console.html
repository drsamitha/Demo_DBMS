{% extends "db_connections/base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ORM Console</h2>
                <div>
                    <a href="{% url 'home' %}" class="button me-2">Back to Home</a>
                    <button class="button" onclick="copyToClipboard()">Copy Code</button>
                </div>
            </div>

            <form method="post" class="mb-4" id="ormForm">
                {% csrf_token %}
                <div class="form-group">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label for="orm_code" class="mb-0">Python Code</label>
                        <small class="text-muted">Write your ORM queries here</small>
                    </div>
                    <div class="editor-container">
                        <textarea name="orm_code" id="orm_code">{{ orm_code }}</textarea>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <button type="submit" class="button">Execute Code</button>
                    <a href="{% url 'view_models' %}" class="button">View Models</a>
                </div>
            </form>

            <div id="resultContainer" class="card mb-4" style="display: none;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Result</h5>
                </div>
                <div class="card-body">
                    <pre class="code-block" id="resultContent"></pre>
                    <div id="errorActions" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <button type="button" class="button" id="tryAgainBtn">Try Again</button>
                            <div id="progressIndicator" class="ms-3" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2 text-muted">Getting AI help...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface Section -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Chat Interface</h5>
                </div>
                <div class="card-body">
                    <div class="chat-messages" id="chatMessages" style="height: 300px; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">
                        <!-- Chat messages will appear here -->
                    </div>
                    <form id="chatForm" class="d-flex">
                        <div class="d-flex align-items-center me-2" style="min-width: 200px;">
                            <label for="tokenCount" class="me-2 mb-0">Expected Response Length:</label>
                            <input type="range" class="form-range" id="tokenCount" min="64" max="512" value="128" step="64" style="width: 100px;">
                            <span id="tokenValue" class="ms-2">128</span>
                        </div>
                        <input type="text" id="chatInput" class="form-control me-2" placeholder="Type your message..." style="flex-grow: 1;">
                        <button type="submit" class="button">Send</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Example Queries</h5>
                </div>
                <div class="card-body">
                    <pre class="code-block"># List all records
Model.objects.all()

# Filter records
Model.objects.filter(field='value')

# Create a new record
Model.objects.create(field='value')

# Update records
Model.objects.filter(field='value').update(new_field='new_value')

# Delete records
Model.objects.filter(field='value').delete()</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var editor = CodeMirror.fromTextArea(document.getElementById('orm_code'), {
        mode: 'python',
        theme: 'monokai',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
            'Tab': function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection('add');
                } else {
                    cm.replaceSelection('    ', 'end');
                }
            }
        }
    });

    // Handle ORM form submission
    const ormForm = document.getElementById('ormForm');
    ormForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(ormForm);
        
        fetch('{% url "orm_console" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');
            const errorActions = document.getElementById('errorActions');
            
            if (data.error) {
                // Format the error message with syntax highlighting
                const errorLines = data.error.split('\n');
                let formattedError = '';
                errorLines.forEach(line => {
                    if (line.startsWith('Error Type:')) {
                        formattedError += `<span class="text-danger fw-bold">${line}</span>\n`;
                    } else if (line.startsWith('Error Message:')) {
                        formattedError += `<span class="text-danger">${line}</span>\n`;
                    }
                });
                resultContent.innerHTML = formattedError;
                errorActions.style.display = 'block';
                // Store the error message and code for retry
                window.lastError = {
                    error: data.error,
                    code: editor.getValue()
                };
            } else if (data.result) {
                resultContent.textContent = data.result;
                errorActions.style.display = 'none';
            }
            resultContainer.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');
            const errorActions = document.getElementById('errorActions');
            resultContent.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
            errorActions.style.display = 'block';
            resultContainer.style.display = 'block';
        });
    });

    // Add token count slider event listener
    document.getElementById('tokenCount').addEventListener('input', function(e) {
        document.getElementById('tokenValue').textContent = e.target.value;
    });

    // Function to handle error retry with AI
    function handleErrorRetry() {
        if (!window.lastError) return;
        
        const tokenCount = document.getElementById('tokenCount').value;
        const errorMessage = `I got this error while executing ORM code:\n${window.lastError.error}\n\nHere's the code I tried to run:\n\n${window.lastError.code}\n\ngive only the new ORM to fix this?`;
        
        // Show progress indicator and disable button
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const progressIndicator = document.getElementById('progressIndicator');
        tryAgainBtn.disabled = true;
        progressIndicator.style.display = 'flex';
        
        fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                message: errorMessage,
                max_tokens: parseInt(tokenCount)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.message) {
                editor.setValue(data.message);
                // Hide the error actions after successful retry
                document.getElementById('errorActions').style.display = 'none';
            } else {
                // Show error in result container
                const resultContent = document.getElementById('resultContent');
                resultContent.innerHTML = `<span class="text-danger">Error: ${data.message || 'Failed to get AI help'}</span>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error in result container
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `<span class="text-danger">Error: ${error.message || 'Failed to get AI help'}</span>`;
        })
        .finally(() => {
            // Hide progress indicator and enable button
            tryAgainBtn.disabled = false;
            progressIndicator.style.display = 'none';
        });
    }

    // Add click event listener to Try Again button
    document.getElementById('tryAgainBtn').addEventListener('click', handleErrorRetry);

    // Chat interface functionality
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
            // Add user message to chat
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'mb-2';
            userMessageDiv.innerHTML = `
                <div class="d-flex justify-content-end">
                    <div class="bg-primary text-white p-2 rounded" style="max-width: 70%;">
                        ${message}
                    </div>
                </div>
            `;
            chatMessages.appendChild(userMessageDiv);
            
            // Clear input
            chatInput.value = '';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text().then(text => {
                    try {
                        return text ? JSON.parse(text) : {};
                    } catch (e) {
                        console.error('JSON Parse Error:', e);
                        console.error('Response text:', text);
                        throw new Error('Invalid JSON response from server');
                    }
                });
            })
            .then(data => {
                console.log('Received data:', data);  // Debug log
                if (data.status === 'success' && (data.message || data.generated_code)) {
                    // Extract the content from either message or generated_code
                    const messageContent = data.generated_code || data.message;
                    
                    // Add response to chat
                    const responseMessageDiv = document.createElement('div');
                    responseMessageDiv.className = 'mb-2';
                    responseMessageDiv.innerHTML = `
                        <div class="d-flex justify-content-start">
                            <div class="bg-light text-dark p-2 rounded" style="max-width: 70%;">
                                <pre class="mb-0">${messageContent}</pre>
                            </div>
                        </div>
                    `;
                    chatMessages.appendChild(responseMessageDiv);

                    // Set the code in the editor
                    editor.setValue(messageContent);
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    // Handle error response
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'mb-2';
                    errorMessageDiv.innerHTML = `
                        <div class="d-flex justify-content-start">
                            <div class="bg-danger text-white p-2 rounded" style="max-width: 70%;">
                                Error: ${data.message || 'Unknown error occurred'}
                            </div>
                        </div>
                    `;
                    chatMessages.appendChild(errorMessageDiv);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Add error message to chat
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'mb-2';
                errorMessageDiv.innerHTML = `
                    <div class="d-flex justify-content-start">
                        <div class="bg-danger text-white p-2 rounded" style="max-width: 70%;">
                            Error: ${error.message || 'Failed to get response from server'}
                        </div>
                    </div>
                `;
                chatMessages.appendChild(errorMessageDiv);
            });
        }
    });
});

function copyToClipboard() {
    var editor = document.querySelector('.CodeMirror').CodeMirror;
    var text = editor.getValue();
    
    navigator.clipboard.writeText(text).then(function() {
        var button = document.querySelector('.button');
        var originalText = button.textContent;
        button.textContent = 'Copied!';
        setTimeout(function() {
            button.textContent = originalText;
        }, 2000);
    });
}
</script>
{% endblock %}
